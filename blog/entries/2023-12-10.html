<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../styles.css">
    <link rel="stylesheet" href="../prism.css">
    <script src="../prism.js"></script>
    <title>Dev Log</title>
</head>
<body>
    <header>
        <h1>Handling Collision</h1>
        <p>Published on: <time datetime="2023-12-10">December 10, 2023</time></p>
    </header>

    <section id="content">
        <p>I'm on the third day of porting InfiniteAbyss to Defold from Unity. Today I'm working on collision. 
            I added a vector in the init for collision to correct the player</p>
        <pre class="line-numbers"><code class="language-lua">
-- player.script
function init(self)
    -- code omitted for brevity
    -- correction vector for collision
    self.correction = vmath.vector3()
end
        </code></pre>

        <p>Next, In the update function, I reset the correction vector to zero. 
            This is so after the player isn't touching anything, the correction vector will reset.
        </p>
        <pre class="line-numbers"><code class="language-lua">
-- player.script
function update(self, dt)
    -- code omitted for brevity
    -- reset correction
    self.correction = vmath.vector3()
end
        </code></pre>

        <p>Finally, in the on_message function, I handle the collision. 
            I get the distance from the collision, and if it's greater than zero, 
            I project the accumulated correction onto the penetration vector. 
            If the projection is less than one, I get the compensation and apply it. 
            Then I accumulate the correction done.
        </p>
        <pre class="line-numbers"><code class="language-lua">
-- player.script
function on_message(self, message_id, message, sender)
	if debugCollision then print("Collision on_message") end
	-- Handle collision
	if message_id == hash("contact_point_response") then
		-- Get the info needed to move out of collision. We might
		-- get several contact points back and have to calculate
		-- how to move out of all of them by accumulating a
		-- correction vector for this frame:
		if message.distance > 0 then
			-- First, project the accumulated correction onto
			-- the penetration vector
			local proj = vmath.project(self.correction, message.normal * message.distance)
			if proj < 1 then
				-- Only care for projections that does not overshoot.
				local comp = (message.distance - message.distance * proj) * message.normal
				-- Apply compensation
				go.set_position(go.get_position() + comp)
				-- Accumulate correction done
				self.correction = self.correction + comp
			end
		end
	end
end
                    </code></pre>
                    <p>And voila just like that we now have collision</p>
                    <img src="./2023-12-10.gif" alt="Character collides with tilemap." width="300" height="auto">



    </section>

    <section id="back-to-blog">
        <a href="../../blog/blog-index.html">Back to blog index</a>
    </section>
</body>
</html>
